<a href="/" class="back-link">‚Üê Essays. Thoughts. Letters.</a>

<div class="zoom-control">
    <div class="zoom-slider">
        {{#each zoomLevels}}
            <a href="?zoom={{@key}}" 
               class="zoom-level 
                    {{#if (eq @key ../zoomLevel)}}active{{/if}}
                    {{#if (eq @key ../naturalZoomLevel)}}natural{{/if}}
                    {{#if (lookup (lookup ../essay.versions @key) 'isOriginal')}}original{{/if}}
                    {{#unless (or 
                        (lookup (lookup ../essay.versions @key) 'isOriginal')
                        (lookup (lookup ../essay.versions @key) 'isHumanVetted')
                    )}}ai{{/unless}}"
               title="{{this.description}} 
                      {{#if (lookup ../essay.versions @key)}}
                          ({{lookup (lookup ../essay.versions @key) 'wordCount'}} words)
                          {{#if (lookup (lookup ../essay.versions @key) 'isOriginal')}}
                              - Original Version
                          {{else if (lookup (lookup ../essay.versions @key) 'isHumanVetted')}}
                              - Human-Reviewed Version
                          {{else}}
                              - AI-Generated
                          {{/if}}
                      {{/if}}">
                {{this.name}}
                <span class="status"></span>
            </a>
        {{/each}}
    </div>
    
    {{#if isGenerating}}
        <div class="version-info">
            Generating {{currentZoom.name}} version...
        </div>
    {{else if (lookup essay.versions zoomLevel)}}
        <div class="version-info">
            {{#if (lookup (lookup essay.versions zoomLevel) 'isOriginal')}}
                This is the original version ({{lookup (lookup essay.versions zoomLevel) 'wordCount'}} words).
            {{else if (lookup (lookup essay.versions zoomLevel) 'isHumanVetted')}}
                This is an AI-generated, human-reviewed version ({{lookup (lookup essay.versions zoomLevel) 'wordCount'}} words).
            {{else}}
                This is an AI-generated version ({{lookup (lookup essay.versions zoomLevel) 'wordCount'}} words, not yet human-reviewed).
            {{/if}}
        </div>
    {{else}}
        <div class="version-info">
            {{currentZoom.name}} version not yet generated.
        </div>
    {{/if}}
</div>

<hr />

{{#if (eq zoomLevel '1m')}}
<h1>{{title}}</h1>
<div class="tldr-header">TL;DR</div>
{{{html}}}
{{else}}
{{{html}}}
{{/if}}

{{#if isGenerating}}
<script>
    function checkVersion() {
        fetch('/{{slug}}/check-version?zoom={{zoomLevel}}')
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    window.location.reload();
                }
            })
            .catch(console.error);
    }

    // Poll every 2 seconds
    const pollInterval = setInterval(checkVersion, 2000);

    // Stop polling after 60 seconds (30 attempts)
    setTimeout(() => {
        clearInterval(pollInterval);
        // Update the generating message if we timeout
        const generating = document.querySelector('.generating');
        if (generating) {
            generating.innerHTML = `
                <h2>Taking longer than expected...</h2>
                <p>Please refresh the page manually to check if the version is ready.</p>
            `;
        }
    }, 60000);
</script>
{{/if}}